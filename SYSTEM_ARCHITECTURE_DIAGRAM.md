# Cloud Workload Anomaly Detection System - Architecture

## System Architecture Diagram

```mermaid
graph TB
    subgraph "Data Layer"
        BQ[(BigQuery)]
        WD[Workload Dataset]
        BT[Baseline Table]
        AT[Anomaly Table]
        AAT[Anomaly Analysis Table]
        FT[Feedback Table]
    end

    subgraph "Agent Layer"
        BA[Baseline Agent]
        
        subgraph "Anomaly Detection Agents"
            ADA1[Error Rate Detector]
            ADA2[CPU Spike Detector]
            ADA3[Memory Spike Detector]
            ADA4[Performance Detector]
            ADA5[Cost Anomaly Detector]
        end
        
        IA[Insight Agent]
        PA[Presentation Agent]
    end

    subgraph "Service Layer"
        NS[Notification Service]
        CS[Configuration Service]
    end

    subgraph "UI Layer"
        UI[Web Dashboard]
        AD[Anomaly Display]
        CM[Configuration Management]
        FB[Feedback System]
        AL[Alert Panel]
    end

    %% Data Flow - Baseline Agent
    WD -->|Read workload data| BA
    BA -->|Calculate baselines| BT
    BT -->|Store baseline stats| BQ

    %% Data Flow - Anomaly Detection
    WD -->|Read current metrics| ADA1
    WD -->|Read current metrics| ADA2
    WD -->|Read current metrics| ADA3
    WD -->|Read current metrics| ADA4
    WD -->|Read current metrics| ADA5
    
    BT -->|Read baseline data| ADA1
    BT -->|Read baseline data| ADA2
    BT -->|Read baseline data| ADA3
    BT -->|Read baseline data| ADA4
    BT -->|Read baseline data| ADA5

    ADA1 -->|Detected anomalies| AT
    ADA2 -->|Detected anomalies| AT
    ADA3 -->|Detected anomalies| AT
    ADA4 -->|Detected anomalies| AT
    ADA5 -->|Detected anomalies| AT
    AT -->|Store anomalies| BQ

    %% Data Flow - Insight Agent
    AT -->|Read anomalies| IA
    BT -->|Read baseline context| IA
    WD -->|Read historical data| IA
    IA -->|Root cause & recommendations| AAT
    AAT -->|Store analysis| BQ

    %% Data Flow - Presentation Agent
    AAT -->|Read analysis| PA
    AT -->|Read anomalies| PA
    PA -->|Format for display| UI

    %% Data Flow - Notification System
    AAT -->|New anomalies| NS
    NS -->|Push notifications| UI
    NS -->|Email/Slack alerts| AL

    %% Data Flow - UI Layer
    UI --> AD
    UI --> CM
    UI --> FB
    UI --> AL
    
    CM -->|Update config| CS
    CS -->|Configure agents| BA
    CS -->|Configure agents| ADA1
    CS -->|Configure agents| ADA2
    CS -->|Configure agents| ADA3
    CS -->|Configure agents| ADA4
    CS -->|Configure agents| ADA5
    
    FB -->|User feedback| FT
    FT -->|Store feedback| BQ
    FT -->|Improve analysis| IA

    %% Styling
    classDef dataLayer fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef agentLayer fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef serviceLayer fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef uiLayer fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    
    class BQ,WD,BT,AT,AAT,FT dataLayer
    class BA,ADA1,ADA2,ADA3,ADA4,ADA5,IA,PA agentLayer
    class NS,CS serviceLayer
    class UI,AD,CM,FB,AL uiLayer
```

## Component Descriptions

### Data Layer (BigQuery)

#### **Workload Dataset**
- Source data containing cloud workload metrics
- Columns: CPU utilization, memory consumption, error rates, execution times
- Updated continuously from cloud infrastructure

#### **Baseline Table**
- Stores calculated baseline statistics for each metric
- Generated by Baseline Agent
- Contains: mean, std_dev, percentiles, confidence intervals

#### **Anomaly Table**
- Stores detected anomalies
- Contains: anomaly_id, metric_name, current_value, baseline_value, deviation_sigma, severity

#### **Anomaly Analysis Table**
- Stores detailed analysis of each anomaly
- Contains: root_cause, recommendations, impact_assessment, confidence_score

#### **Feedback Table**
- Stores user feedback on anomaly analyses
- Used to improve future detections and recommendations

---

### Agent Layer

#### **Baseline Agent**
- **Input**: Workload Dataset from BigQuery
- **Process**: 
  - Calculates statistical baselines for each metric
  - Uses AI-optimization to select best calculation method
  - Computes mean, standard deviation, percentiles
- **Output**: Baseline statistics stored in Baseline Table

#### **Anomaly Detection Agents** (Multiple Specialized Agents)

1. **Error Rate Detector**
   - Monitors error rate anomalies
   - Detects stability issues

2. **CPU Spike Detector**
   - Monitors CPU utilization
   - Detects resource bottlenecks

3. **Memory Spike Detector**
   - Monitors memory consumption
   - Detects memory leaks and spikes

4. **Performance Detector**
   - Monitors execution times
   - Detects performance degradation

5. **Cost Anomaly Detector**
   - Monitors resource costs
   - Detects unexpected cost increases

**Common Process**:
- **Input**: Current metrics from Workload Dataset + Baseline data
- **Process**: Compare current values against baselines using statistical methods (z-score, percentile)
- **Output**: Detected anomalies stored in Anomaly Table

#### **Insight Agent**
- **Input**: 
  - Detected anomalies from Anomaly Table
  - Baseline context from Baseline Table
  - Historical data from Workload Dataset
- **Process**:
  - Performs root cause analysis using AI (Gemini)
  - Generates actionable recommendations
  - Assesses business impact
  - Detects correlations and patterns
- **Output**: Detailed analysis stored in Anomaly Analysis Table

#### **Presentation Agent**
- **Input**: 
  - Anomaly analysis from Anomaly Analysis Table
  - Anomaly details from Anomaly Table
- **Process**:
  - Formats data for UI consumption
  - Creates human-readable summaries
  - Prioritizes information
  - Generates visualizations data
- **Output**: Formatted data sent to UI Layer

---

### Service Layer

#### **Notification Service**
- **Input**: New anomalies from Anomaly Analysis Table
- **Process**:
  - Monitors for new high-severity anomalies
  - Sends real-time notifications
  - Manages notification preferences
- **Output**: 
  - Push notifications to UI
  - Email/Slack alerts
  - Updates Alert Panel

#### **Configuration Service**
- **Input**: Configuration changes from UI
- **Process**:
  - Manages system configuration
  - Updates agent parameters
  - Controls detection thresholds
- **Output**: Configuration updates to all agents

---

### UI Layer

#### **Web Dashboard**
- Central interface for all system interactions
- Displays real-time system status

#### **Anomaly Display**
- Shows detected anomalies with details
- Displays root cause analysis
- Shows recommendations and impact
- Provides historical anomaly trends

#### **Configuration Management**
- Allows users to configure:
  - Detection thresholds
  - Baseline calculation methods
  - Notification preferences
  - Agent enable/disable

#### **Feedback System**
- Allows users to provide feedback on:
  - Accuracy of anomaly detection
  - Usefulness of recommendations
  - False positives/negatives
- Feedback stored in Feedback Table for continuous improvement

#### **Alert Panel**
- Displays real-time notifications
- Shows new anomalies as they're detected
- Provides quick action buttons

---

## Data Flow Summary

1. **Baseline Calculation Flow**:
   ```
   Workload Dataset ‚Üí Baseline Agent ‚Üí Baseline Table
   ```

2. **Anomaly Detection Flow**:
   ```
   Workload Dataset + Baseline Table ‚Üí Detection Agents ‚Üí Anomaly Table
   ```

3. **Analysis Flow**:
   ```
   Anomaly Table + Baseline Table + Workload Dataset ‚Üí Insight Agent ‚Üí Anomaly Analysis Table
   ```

4. **Presentation Flow**:
   ```
   Anomaly Analysis Table + Anomaly Table ‚Üí Presentation Agent ‚Üí UI Layer
   ```

5. **Notification Flow**:
   ```
   Anomaly Analysis Table ‚Üí Notification Service ‚Üí UI Layer + External Alerts
   ```

6. **Feedback Loop**:
   ```
   UI Feedback System ‚Üí Feedback Table ‚Üí Insight Agent (for improvement)
   ```

---

## Key Features

### üîÑ **Continuous Monitoring**
- Agents run continuously or on schedule
- Real-time anomaly detection
- Automatic baseline updates

### ü§ñ **AI-Powered Analysis**
- Baseline Agent uses AI to optimize calculation methods
- Insight Agent uses Gemini for root cause analysis
- Continuous learning from user feedback

### üìä **Multi-Agent Architecture**
- Specialized agents for different anomaly types
- Parallel processing for faster detection
- Modular design for easy expansion

### üîî **Real-Time Notifications**
- Instant alerts for critical anomalies
- Multiple notification channels
- Configurable alert thresholds

### üë• **User Feedback Integration**
- Users can rate anomaly accuracy
- Feedback improves future detections
- Continuous system improvement

### ‚öôÔ∏è **Flexible Configuration**
- UI-based configuration management
- Per-agent configuration
- Dynamic threshold adjustment

---

## Technology Stack

- **Data Storage**: Google BigQuery
- **AI/ML**: Vertex AI (Gemini)
- **Backend**: Python (Cloud Functions / Cloud Run)
- **Frontend**: Web Dashboard (React/Vue)
- **Notifications**: Cloud Pub/Sub, Email, Slack
- **Orchestration**: Cloud Scheduler, Cloud Tasks
